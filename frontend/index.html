<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BiTranslator – 智能全书翻译</title>
  <link rel="stylesheet" href="style.css?v=30" />
</head>
<body>
  <div id="app">
    <!-- Sidebar -->
    <aside id="sidebar">
      <div class="sidebar-top-row">
        <div class="logo">
          <h1>BiTranslator</h1>
          <p class="tagline" data-i18n="tagline">智能全书翻译</p>
          <p class="format-note" data-i18n="epub_only">仅支持 EPUB 格式</p>
        </div>
        <button class="btn-icon sidebar-toggle" id="btn-toggle-sidebar" title="Toggle sidebar">◀</button>
      </div>
      <button class="btn btn-sm sidebar-home-btn" id="btn-home" data-i18n="home">🏠 主页</button>

      <div class="sidebar-section sidebar-lang-section">
        <label data-i18n="language">网站语言
          <select id="app-lang-select">
            <option value="zh">中文</option>
            <option value="en">English</option>
          </select>
        </label>
      </div>

      <div class="sidebar-section">
        <h3 data-i18n="llm_settings">LLM 设置</h3>
        <label data-i18n="provider">提供商
          <select id="llm-provider">
            <option value="gemini" selected>Google Gemini</option>
            <option value="openai">OpenAI / 兼容 API</option>
            <option value="ollama">Ollama (本地)</option>
          </select>
        </label>
        <label id="label-base-url" class="hidden">API Base URL
          <input type="text" id="llm-base-url" value="" />
        </label>
        <label data-i18n="api_key">API Key
          <input type="password" id="llm-api-key" placeholder="AIza..." />
        </label>
        <div id="api-key-warning" class="api-key-warning hidden">
          <span data-i18n="api_key_missing">⚠️ 未设置 API Key，请先输入并保存设置</span>
        </div>
        <div class="sidebar-field">
          <span class="sidebar-label" data-i18n="analysis_model">分析模型</span>
          <select id="llm-model">
            <optgroup label="Gemini 2.5">
              <option value="gemini-2.5-pro" selected>Gemini 2.5 Pro</option>
              <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
            </optgroup>
            <optgroup label="Gemini 2.0">
              <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
            </optgroup>
          </select>
          <input type="text" id="llm-model-custom" class="hidden" placeholder="自定义模型名称" />
        </div>
        <div class="sidebar-field">
          <span class="sidebar-label" data-i18n="translation_model">翻译模型 (可选, 留空则使用分析模型)</span>
          <select id="llm-translation-model">
            <option value="">(与分析模型相同)</option>
            <optgroup label="Gemini 2.5">
              <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
              <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
            </optgroup>
            <optgroup label="Gemini 2.0">
              <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
            </optgroup>
          </select>
          <input type="text" id="llm-translation-model-custom" class="hidden" placeholder="自定义翻译模型名称" />
        </div>
        <label>Temperature
          <input type="number" id="llm-temperature" value="0.3" min="0" max="2" step="0.1" />
        </label>
        <button id="btn-save-llm" class="btn btn-sm" data-i18n="save_settings">保存设置</button>
      </div>

      <div class="sidebar-section">
        <h3 data-i18n="projects">项目列表</h3>
        <div id="project-list"></div>
      </div>
    </aside>

    <!-- Main content -->
    <main id="main">
      <!-- Step indicator -->
      <div id="steps-bar" class="hidden">
        <div class="step" data-step="upload"><span class="step-num">1</span> <span data-i18n="step_upload">上传</span></div>
        <div class="step" data-step="analysis"><span class="step-num">2</span> <span data-i18n="step_analysis">分析</span></div>
        <div class="step" data-step="strategy"><span class="step-num">3</span> <span data-i18n="step_strategy">策略</span></div>
        <div class="step" data-step="sample"><span class="step-num">4</span> <span data-i18n="step_sample">样章</span></div>
        <div class="step" data-step="translate"><span class="step-num">5</span> <span data-i18n="step_translate">翻译</span></div>
        <div class="step" data-step="review"><span class="step-num">6</span> <span data-i18n="step_review">审阅</span></div>
        <div class="step" data-step="reader"><span class="step-num">7</span> <span data-i18n="step_reader">阅读</span></div>
        <div class="step" data-step="done"><span class="step-num">8</span> <span data-i18n="step_done">完成</span></div>
      </div>

      <!-- Upload panel -->
      <section id="panel-upload" class="panel active">
        <div class="panel-center">
          <div class="upload-area" id="drop-zone">
            <div class="upload-icon">📖</div>
            <h2 data-i18n="upload_title">上传 EPUB 文件</h2>
            <p>Drop file here or click to select</p>
            <input type="file" id="file-input" accept=".epub" hidden />
            <div class="upload-options">
              <label data-i18n="target_language">目标语言 <input type="text" id="target-lang" value="简体中文" /></label>
            </div>
            <button class="btn btn-primary" id="btn-upload" data-i18n="upload_btn">选择文件并上传</button>
            <div class="import-divider"><span>or</span></div>
            <button class="btn" id="btn-import-project" data-i18n="import_project">📥 导入项目文件 (.json)</button>
            <input type="file" id="import-file-input" accept=".json" hidden />
          </div>
        </div>
      </section>

      <!-- Analysis panel -->
      <section id="panel-analysis" class="panel">
        <h2>📊 书籍深度分析</h2>
        <div id="analysis-loading" class="loading-spinner hidden">
          <p class="hint">AI 正在通读全书，理解上下文、角色、风格…</p>
          <div class="spinner"></div>
          <p id="analysis-loading-text">正在进行在线调研与全书分析，请稍候…</p>
        </div>
        <div id="analysis-content" class="hidden">
          <div class="lang-editor">
            <label>源语言（自动检测） <input type="text" id="edit-source-lang" /></label>
            <label>目标语言 <input type="text" id="edit-target-lang" /></label>
            <button class="btn btn-sm" id="btn-save-langs">保存语言设置</button>
            <span class="hint">如检测有误可手动修改</span>
          </div>

          <!-- Author & Research section -->
          <div class="card full-width research-card">
            <h3>🔍 作者与背景调研</h3>
            <p id="ana-author" style="font-weight:600; margin-bottom:.5rem"></p>
            <details class="research-details">
              <summary>查看完整调研报告</summary>
              <div id="ana-research" class="research-report"></div>
            </details>
          </div>

          <div class="card-grid">
            <div class="card">
              <h3>类型</h3>
              <p id="ana-genre"></p>
            </div>
            <div class="card">
              <h3>主题</h3>
              <ul id="ana-themes"></ul>
            </div>
            <div class="card">
              <h3>写作风格</h3>
              <p id="ana-style"></p>
            </div>
            <div class="card">
              <h3>背景设定</h3>
              <p id="ana-setting"></p>
            </div>
          </div>
          <div class="card full-width">
            <h3>主要角色</h3>
            <div id="ana-characters"></div>
          </div>
          <div class="card full-width">
            <h3>关键术语</h3>
            <div id="ana-terms"></div>
          </div>
          <div class="card full-width">
            <h3>文化背景笔记</h3>
            <p id="ana-cultural"></p>
          </div>
          <div class="card full-width">
            <h3>🌐 作者简介</h3>
            <p id="ana-author-info"></p>
          </div>
          <div class="card full-width">
            <h3>📋 翻译建议</h3>
            <p id="ana-translation-notes"></p>
          </div>
          <div class="card full-width">
            <h3>📚 章节概览</h3>
            <p id="ana-chapter-count"></p>
            <div id="ana-chapter-list" class="chapter-overview-list"></div>
          </div>

          <div class="feedback-section">
            <h3>💬 分析有误？提交修正意见</h3>
            <p class="hint">如果发现角色名称、术语、背景设定等分析有误，请在此描述需要修改的内容，AI 会根据您的反馈重新分析。</p>
            <textarea id="analysis-feedback" rows="4" placeholder="例如：主角的名字应该是「张三」不是「张四」；这本书的时代背景是近未来不是当代；术语 XX 的解释不对…"></textarea>
            <button class="btn" id="btn-refine-analysis">🔄 根据反馈重新分析</button>
          </div>

          <button class="btn btn-primary" id="btn-gen-strategy">生成翻译策略 →</button>
        </div>
      </section>

      <!-- Strategy panel -->
      <section id="panel-strategy" class="panel">
        <h2>📝 翻译策略</h2>
        <div id="strategy-loading" class="loading-spinner hidden">
          <p class="hint">审阅并自定义翻译策略，确保翻译符合您的期望</p>
          <div class="spinner"></div>
          <p>生成策略中…</p>
        </div>
        <div id="strategy-content" class="hidden">
          <div class="strategy-field">
            <label>整体翻译方针</label>
            <textarea id="strat-approach" rows="3"></textarea>
          </div>
          <div class="strategy-field">
            <label>语气与风格</label>
            <textarea id="strat-tone" rows="3"></textarea>
          </div>
          <div class="strategy-field">
            <label>文化适配</label>
            <textarea id="strat-cultural" rows="3"></textarea>
          </div>
          <div class="strategy-field">
            <label>特殊注意事项</label>
            <textarea id="strat-special" rows="3"></textarea>
          </div>
          <div class="strategy-field full-width annotation-options">
            <label data-i18n="annotation_options">标注选项</label>
            <div class="checkbox-row">
              <label class="checkbox-label">
                <input type="checkbox" id="strat-annotate-terms">
                <span data-i18n="annotate_terms">对无通用标准译名的书名、地名、专业术语，在每次请求文本中首次出现时用括号标注原文</span>
              </label>
            </div>
            <div class="checkbox-row">
              <label class="checkbox-label">
                <input type="checkbox" id="strat-annotate-names">
                <span data-i18n="annotate_names">对非主角人名，在每次请求文本中首次出现时用括号标注原文；同一句出现大量不重要人名时仅标注关键角色</span>
              </label>
            </div>
            <p class="hint" data-i18n="annotate_hint">例：默里（Murray）和汤普森（Thompson）走进房间，侍者汉斯递上了菜单。← 汉斯为一次性角色，不标注。日内瓦、霍格沃茨等有公认译名的地名不标注。</p>
          </div>

          <div class="strategy-field full-width annotation-options">
            <label data-i18n="translation_style_options">翻译风格选项</label>
            <div class="checkbox-row">
              <label class="checkbox-label">
                <input type="checkbox" id="strat-free-translation">
                <span data-i18n="free_translation">长难句优先意译：遇到复杂长句时优先拆分、重组以保证可读性，而非保持原句结构</span>
              </label>
            </div>
            <div class="checkbox-row">
              <label class="checkbox-label">
                <input type="checkbox" id="strat-enable-annotations">
                <span data-i18n="enable_annotations">生成翻译附注：AI 在翻译时额外生成长难句/文化背景的意译分析注释，可在阅读器中查看</span>
              </label>
            </div>
            <div class="annotation-density-row" id="annotation-density-row">
              <label data-i18n="annotation_density">附注密度：</label>
              <select id="strat-annotation-density">
                <option value="verbose" data-i18n="density_verbose">详尽</option>
                <option value="normal" selected data-i18n="density_normal">适中</option>
                <option value="minimal" data-i18n="density_minimal">精简</option>
              </select>
              <span class="hint" id="density-hint" data-i18n="density_hint_normal">每段 3-8 条，标注关键翻译选择</span>
            </div>
            <p class="hint" data-i18n="annotations_hint">附注会解释翻译选择、原文直译含义和文化背景，方便深度阅读对比。可在阅读器中切换显示，也可导出为 EPUB。</p>
          </div>

          <div class="strategy-field full-width">
            <label data-i18n="character_names">角色名翻译</label>
            <p class="hint editable-hint" data-i18n="click_to_edit_names">✏️ 点击单元格可直接编辑名称和译文</p>
            <table id="strat-names-table" class="editable-table">
              <thead><tr><th data-i18n="original">原文</th><th data-i18n="translated">译文</th><th data-i18n="note">备注</th><th></th></tr></thead>
              <tbody id="strat-names"></tbody>
            </table>
            <button class="btn btn-sm btn-outline" id="btn-add-name" data-i18n="add_row">+ 添加角色</button>
          </div>
          <div class="strategy-field full-width">
            <label data-i18n="glossary">术语表</label>
            <p class="hint editable-hint" data-i18n="click_to_edit_glossary">✏️ 点击单元格可直接编辑术语和译文</p>
            <table id="strat-glossary-table" class="editable-table">
              <thead><tr><th data-i18n="original">原文</th><th data-i18n="translated">译文</th><th data-i18n="context">上下文</th><th></th></tr></thead>
              <tbody id="strat-glossary"></tbody>
            </table>
            <button class="btn btn-sm btn-outline" id="btn-add-glossary" data-i18n="add_glossary_row">+ 添加术语</button>
          </div>
          <div class="strategy-field full-width">
            <label>自定义指令（您的额外要求）</label>
            <textarea id="strat-custom" rows="4" placeholder="例如：翻译口吻要活泼一些；主角的名字翻译为…"></textarea>
          </div>
          <div class="feedback-section">
            <h3>💬 策略不满意？提交反馈重新生成</h3>
            <p class="hint">AI 会结合您的反馈和当前策略中的手动修改重新生成翻译策略。</p>
            <textarea id="strategy-feedback" rows="3" placeholder="例如：翻译风格应该更口语化；角色名全部音译；某些术语需要统一…"></textarea>
            <button class="btn" id="btn-regen-strategy">🔄 根据反馈重新生成策略</button>
          </div>
          <div class="strategy-version-section">
            <div class="section-header-row">
              <h3>📋 <span data-i18n="strategy_versions">策略版本历史</span></h3>
              <span class="current-ver-badge" id="strategy-current-ver"></span>
            </div>
            <div id="strategy-versions-list" class="versions-list"></div>
            <div id="strategy-version-preview" class="strategy-version-preview hidden">
              <div class="preview-header">
                <h4 id="strat-preview-title"></h4>
                <button class="btn-icon" id="btn-close-strat-preview">✕</button>
              </div>
              <div class="preview-fields" id="strat-preview-fields"></div>
              <div class="btn-row" style="margin-top:.5rem">
                <button class="btn btn-primary btn-sm" id="btn-use-strat-version" data-i18n="ver_use">使用此版本</button>
              </div>
            </div>
          </div>
          <div class="strategy-template-section">
            <h3>💾 <span data-i18n="strategy_templates">策略模板</span></h3>
            <p class="hint" data-i18n="template_hint">保存当前策略为模板，以后可一键应用到其他书目。</p>
            <div class="template-save-row">
              <input type="text" id="template-name-input" placeholder="模板名称" class="template-input" />
              <input type="text" id="template-desc-input" placeholder="备注说明（可选）" class="template-input" />
              <button class="btn btn-sm" id="btn-save-template" data-i18n="save_as_template">💾 保存为模板</button>
            </div>
            <div id="template-list" class="template-list"></div>
          </div>
          <div class="sample-chapter-picker">
            <label>选择样章：第
              <select id="sample-chapter-select"></select>
            章</label>
            <span class="hint">（许多书第一章是介绍/序言，建议选择正文开始的章节）</span>
          </div>
          <div class="btn-row">
            <button class="btn btn-outline" id="btn-back-to-analysis">← 返回分析</button>
            <button class="btn" id="btn-save-strategy">保存修改</button>
            <button class="btn btn-primary" id="btn-translate-sample">翻译样章 →</button>
          </div>
        </div>
      </section>

      <!-- Sample panel -->
      <section id="panel-sample" class="panel">
        <h2>📑 样章审阅</h2>
        <div id="sample-loading" class="loading-spinner hidden">
          <p class="hint">审阅样章的翻译效果。如不满意，可提供反馈让 AI 调整策略并重新翻译样章。</p>
          <div class="spinner"></div>
          <p id="sample-loading-text">翻译样章中…</p>
        </div>
        <div id="sample-content" class="hidden">
          <div class="comparison">
            <div class="comparison-col">
              <h3>原文</h3>
              <div id="sample-original" class="text-display"></div>
            </div>
            <div class="comparison-col">
              <h3>译文</h3>
              <div id="sample-translated" class="text-display"></div>
            </div>
          </div>

          <div class="sample-actions">
            <div class="sample-action-card">
              <h3>🔄 不满意？提供反馈重新翻译</h3>
              <p class="hint">AI 会根据您的反馈调整翻译策略，然后重新翻译样章。</p>
              <textarea id="sample-feedback" rows="4" placeholder="例如：语气可以更正式一些；人名翻译需要调整；某些术语翻译不准确…"></textarea>
              <button class="btn" id="btn-refine-and-retranslate">提交反馈并重新翻译样章</button>
            </div>
            <div class="sample-action-card highlight">
              <h3>✅ 满意！选择翻译章节</h3>
              <p class="hint">参考上方目录结构，选择要翻译的编号范围。可以先翻译几项试读，之后随时继续。</p>
              <div id="sample-chapter-overview" class="chapter-overview-list" style="max-height:200px; margin-bottom:.75rem"></div>
              <div class="chapter-range-picker">
                <label><span data-i18n="from_chapter">从第</span> <input type="number" id="range-start" min="1" value="1" class="range-input" /> <span data-i18n="chapter_unit">项</span></label>
                <label><span data-i18n="to_chapter">到第</span> <input type="number" id="range-end" min="1" value="1" class="range-input" /> <span data-i18n="chapter_unit">项</span></label>
                <span class="range-hint" id="range-hint"></span>
              </div>
              <div class="range-presets" id="range-presets"></div>
              <button class="btn btn-primary btn-lg" id="btn-translate-all" data-i18n="start_full_translate">开始翻译选定内容 →</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Full translation panel -->
      <section id="panel-translate" class="panel">
        <h2>🔄 全书翻译中</h2>
        <div id="translate-progress">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <p id="progress-text">准备中…</p>
          <button class="btn btn-danger" id="btn-stop-translate">⏹ 停止翻译</button>
          <div id="chapter-status-list"></div>
        </div>
      </section>

      <!-- Review panel -->
      <section id="panel-review" class="panel">
        <h2 data-i18n="review_title">📖 审阅译文</h2>
        <p class="hint" data-i18n="review_hint">点击已翻译的章节进入阅读器阅读。如果对某章不满意，可以在阅读器中重新翻译。</p>
        <div class="review-title-actions">
          <button class="btn btn-sm" id="btn-review-edit-titles" data-i18n="edit_chapter_titles">✏️ 编辑章节标题</button>
          <button class="btn btn-sm" id="btn-toggle-name-table" data-i18n="name_table">📋 全书人名表</button>
          <span class="hint" data-i18n="edit_titles_note">可设置前言/正文/附录类型，编辑双语标题</span>
        </div>

        <div class="review-filter-bar">
          <label data-i18n="filter_label">筛选：</label>
          <button class="btn btn-xs review-filter-btn active" data-filter="all" data-i18n="filter_all">全部</button>
          <button class="btn btn-xs review-filter-btn" data-filter="translated" data-i18n="filter_translated">已翻译</button>
          <button class="btn btn-xs review-filter-btn" data-filter="untranslated" data-i18n="filter_untranslated">未翻译</button>
        </div>

        <div class="review-chapter-list" id="review-chapter-list"></div>

        <div class="review-footer">
          <div class="review-translate-more" id="review-translate-more">
            <span data-i18n="translate_more">📖 继续翻译</span>
            <label><span data-i18n="from_chapter">从第</span> <input type="number" id="review-range-start" min="1" value="1" class="range-input" /> <span data-i18n="chapter_unit">项</span></label>
            <label><span data-i18n="to_chapter">到第</span> <input type="number" id="review-range-end" min="1" value="1" class="range-input" /> <span data-i18n="chapter_unit">项</span></label>
            <span class="range-hint" id="review-range-hint"></span>
            <button class="btn btn-sm" id="btn-translate-more" data-i18n="start_translate">翻译 →</button>
          </div>
          <button class="btn btn-primary" id="btn-review-done" data-i18n="confirm_done">确认完成，前往下载 →</button>
        </div>
      </section>

      <!-- Reader panel -->
      <section id="panel-reader" class="panel">
        <div class="reader-toolbar">
          <button class="btn btn-sm" id="btn-reader-exit" data-icon="↩" data-i18n="back_to_review">← 返回审阅</button>
          <div class="reader-nav">
            <button class="btn btn-sm" id="btn-reader-prev" data-icon="◀" disabled data-i18n="prev_chapter">◀ 上一章</button>
            <span id="reader-nav-label" class="reader-nav-label"></span>
            <button class="btn btn-sm" id="btn-reader-next" data-icon="▶" data-i18n="next_chapter">下一章 ▶</button>
          </div>
          <button class="btn btn-sm btn-immersive" id="btn-reader-immersive" data-icon="📖" data-i18n="immersive_mode" title="沉浸式阅读">📖 沉浸阅读</button>
          <div class="reader-toolbar-actions">
            <button class="btn btn-danger btn-sm" id="btn-reader-retranslate" data-icon="🔄" data-i18n="retranslate_this">🔄 重新翻译本章</button>
            <button class="btn btn-sm" id="btn-reader-versions" data-icon="📋" data-i18n="version_history">📋 版本</button>
            <label class="reader-toggle" data-icon="📖">
              <input type="checkbox" id="reader-show-original" checked />
              <span data-i18n="show_original">显示原文</span>
            </label>
            <label class="reader-toggle" data-icon="💡">
              <input type="checkbox" id="reader-show-annotations" />
              <span data-i18n="show_annotations">显示附注</span>
            </label>
            <button class="btn btn-sm" id="btn-view-all-annotations" data-icon="📝" data-i18n="view_all_annotations">📝 查看所有附注</button>
            <button class="btn btn-sm" id="btn-quick-translate-titles" data-icon="🤖" data-i18n="ai_translate_titles_short">🤖 翻译标题</button>
            <button class="btn btn-sm" id="btn-edit-titles" data-icon="✏️" data-i18n="edit_chapter_titles">✏️ 编辑章节标题</button>
            <div class="reader-settings-wrap">
              <button class="btn btn-sm" id="btn-reader-settings" data-icon="⚙️">⚙️</button>
              <div id="reader-settings-dropdown" class="reader-settings-dropdown hidden">
                <div class="rset-group">
                  <label data-i18n="reader_height">阅读框高度</label>
                  <div class="rset-options" id="rset-height">
                    <button class="rset-opt" data-val="compact" data-i18n="height_compact">紧凑</button>
                    <button class="rset-opt active" data-val="standard" data-i18n="height_standard">标准</button>
                    <button class="rset-opt" data-val="tall" data-i18n="height_tall">最大</button>
                  </div>
                </div>
                <div class="rset-group">
                  <label data-i18n="reader_font_size">字体大小</label>
                  <div class="rset-options" id="rset-fontsize">
                    <button class="rset-opt" data-val="small">A<sup>-</sup></button>
                    <button class="rset-opt active" data-val="medium">A</button>
                    <button class="rset-opt" data-val="large">A<sup>+</sup></button>
                  </div>
                </div>
                <div class="rset-group">
                  <label data-i18n="reader_theme">阅读主题</label>
                  <div class="rset-options" id="rset-theme">
                    <button class="rset-opt" data-val="dark" data-i18n="theme_dark">暗色</button>
                    <button class="rset-opt" data-val="light" data-i18n="theme_light">亮色</button>
                    <button class="rset-opt" data-val="sepia" data-i18n="theme_sepia">护眼</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="reader-book-view" class="reader-book-view">
          <div class="reader-book-pane" id="reader-book-original">
            <div class="reader-book-header">原文</div>
            <div class="reader-book-content" id="reader-book-original-content"></div>
          </div>
          <div class="reader-book-pane" id="reader-book-translated">
            <div class="reader-book-header">译文</div>
            <div class="reader-book-content" id="reader-book-translated-content"></div>
          </div>
        </div>

        <!-- Highlight action bar (shown on text selection) -->
        <div id="reader-highlight-bar" class="reader-highlight-bar hidden">
          <button class="btn btn-sm btn-highlight-action" id="btn-add-highlight">🖍️ <span data-i18n="add_highlight">划线</span></button>
          <button class="btn btn-sm btn-highlight-action" id="btn-add-note">📝 <span data-i18n="add_note">批注</span></button>
        </div>

        <!-- Note input popup -->
        <div id="reader-note-popup" class="reader-note-popup hidden">
          <textarea id="reader-note-input" rows="3" data-i18n="note_placeholder" placeholder="输入笔记…"></textarea>
          <div class="note-popup-actions">
            <button class="btn btn-primary btn-sm" id="btn-save-note" data-i18n="save_note">保存</button>
            <button class="btn btn-sm" id="btn-cancel-note" data-i18n="cancel">取消</button>
          </div>
        </div>

        <!-- AI annotation tooltip (shown when clicking green annotation highlight) -->
        <div id="reader-ann-tooltip" class="reader-ann-tooltip hidden">
          <button class="btn-icon ann-tooltip-close" id="btn-close-ann-tooltip">✕</button>
          <div class="ann-tooltip-body">
            <p class="ann-tooltip-src"><span class="ann-label" data-i18n="annotation_src">原文</span>: <span id="ann-tooltip-src-text"></span></p>
            <p class="ann-tooltip-tgt"><span class="ann-label" data-i18n="annotation_tgt">译文</span>: <span id="ann-tooltip-tgt-text"></span></p>
            <p class="ann-tooltip-note" id="ann-tooltip-note-text"></p>
          </div>
        </div>

        <!-- User highlight/note tooltip (shown when clicking user highlights) -->
        <div id="reader-hl-tooltip" class="reader-hl-tooltip hidden">
          <button class="btn-icon ann-tooltip-close" id="btn-close-hl-tooltip">✕</button>
          <div class="hl-tooltip-body" id="hl-tooltip-content"></div>
        </div>

        <!-- Retranslation feedback modal -->
        <div id="retranslate-overlay" class="modal-overlay hidden">
          <div class="modal-content retranslate-modal">
            <div class="modal-header">
              <h3 data-i18n="retranslate_feedback_title">🔄 重新翻译 — 请提供修改建议</h3>
              <button class="btn-icon" id="btn-close-retranslate-modal">✕</button>
            </div>
            <p class="hint" data-i18n="retranslate_feedback_hint">请描述当前翻译的问题或不足，AI 将结合您的反馈调整策略并重新翻译本章。</p>
            <textarea id="retranslate-feedback" rows="4" data-i18n="retranslate_placeholder" placeholder="例如：语气不够正式；某些人名翻译错误；第三段漏译了关键信息…"></textarea>
            <div class="retranslate-options">
              <div class="checkbox-row">
                <label class="checkbox-label">
                  <input type="checkbox" id="retranslate-update-strategy" checked>
                  <span data-i18n="retranslate_update_strategy">同时更新翻译策略（推荐：让后续章节也受益于此反馈）</span>
                </label>
              </div>
              <div class="checkbox-row">
                <label class="checkbox-label">
                  <input type="checkbox" id="rt-enable-annotations">
                  <span data-i18n="enable_annotations">生成翻译附注</span>
                </label>
              </div>
              <div class="checkbox-row">
                <label class="checkbox-label">
                  <input type="checkbox" id="rt-annotate-terms">
                  <span data-i18n="rt_annotate_terms">标注术语/地名原文</span>
                </label>
              </div>
              <div class="checkbox-row">
                <label class="checkbox-label">
                  <input type="checkbox" id="rt-annotate-names">
                  <span data-i18n="rt_annotate_names">标注人名原文</span>
                </label>
              </div>
              <div class="checkbox-row">
                <label class="checkbox-label">
                  <input type="checkbox" id="rt-free-translation">
                  <span data-i18n="rt_free_translation">长难句优先意译</span>
                </label>
              </div>
              <div class="annotation-density-row compact" id="rt-density-row">
                <label data-i18n="annotation_density">附注密度：</label>
                <select id="rt-annotation-density">
                  <option value="verbose" data-i18n="density_verbose">详尽</option>
                  <option value="normal" selected data-i18n="density_normal">适中</option>
                  <option value="minimal" data-i18n="density_minimal">精简</option>
                </select>
              </div>
            </div>
            <div class="btn-row">
              <button class="btn btn-primary" id="btn-confirm-retranslate" data-i18n="submit_and_retranslate">提交反馈并重新翻译</button>
              <button class="btn" id="btn-cancel-retranslate" data-i18n="cancel">取消</button>
            </div>
          </div>
        </div>

        <!-- Translation version history modal -->
        <div id="versions-overlay" class="modal-overlay hidden">
          <div class="modal-content versions-modal">
            <div class="modal-header">
              <h3 data-i18n="version_history_title">📋 翻译版本历史</h3>
              <button class="btn-icon" id="btn-close-versions-modal">✕</button>
            </div>
            <div id="versions-list" class="versions-list"></div>
            <div id="version-compare" class="version-compare hidden">
              <h4 data-i18n="version_compare_title">版本对比</h4>
              <div class="comparison">
                <div class="comparison-col">
                  <h5 id="version-compare-label-current">当前版本</h5>
                  <div id="version-compare-current" class="text-display version-text"></div>
                </div>
                <div class="comparison-col">
                  <h5 id="version-compare-label-old">历史版本</h5>
                  <div id="version-compare-old" class="text-display version-text"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- All annotations modal overlay -->
        <div id="annotations-overlay" class="modal-overlay hidden">
          <div class="modal-content annotations-modal">
            <div class="modal-header">
              <h3 data-i18n="annotations_panel">📝 翻译附注</h3>
              <button class="btn-icon" id="btn-close-annotations-modal">✕</button>
            </div>
            <div id="annotations-modal-list" class="annotations-modal-list"></div>
          </div>
        </div>

        <!-- Floating buttons (immersive mode only) -->
        <button class="immersive-ai-fab hidden" id="immersive-ai-fab" title="AI 助手">💬</button>
        <button class="immersive-menu-fab hidden" id="immersive-menu-fab" title="菜单">☰</button>

        <!-- AI Q&A -->
        <div class="reader-qa" id="reader-qa">
          <div class="reader-qa-header">
            <h4 data-i18n="ai_assistant">🤖 AI 翻译助手</h4>
            <p class="hint" data-i18n="ai_hint">选中文字后提问，或直接输入问题</p>
          </div>
          <div id="reader-qa-messages" class="reader-qa-messages"></div>
          <div class="reader-qa-input">
            <div id="reader-qa-selection" class="reader-qa-selection hidden">
              <span class="reader-qa-selection-label" data-i18n="selected_text">选中文字：</span>
              <span id="reader-qa-selection-text"></span>
              <button class="btn-icon" id="btn-clear-selection">✕</button>
            </div>
            <div class="reader-qa-input-row">
              <input type="text" id="reader-qa-question" data-i18n="ask_placeholder" placeholder="例如：这里为什么这样翻译？原文是什么意思？" />
              <button class="btn btn-primary btn-sm" id="btn-reader-ask" data-i18n="ask_btn">提问</button>
            </div>
          </div>
        </div>

      </section>

      <!-- Done panel -->
      <section id="panel-done" class="panel">
        <h2 id="done-title" data-i18n="translate_done">✅ 翻译完成！</h2>
        <p id="done-hint" data-i18n="done_hint_complete">每章译文已单独保存为 EPUB。您可以逐章下载，也可以合并为完整译本。</p>

        <div class="done-actions">
          <button class="btn btn-primary btn-lg" id="btn-open-download-panel" data-i18n="download_options">📥 下载 / 导出</button>
          <button class="btn" id="btn-back-to-review" data-i18n="back_to_review">← 返回审阅</button>
          <button class="btn" id="btn-resume-translate" style="display:none" data-i18n="continue_translate">继续翻译剩余章节</button>
          <button class="btn" id="btn-new-project" data-i18n="new_book">翻译新书</button>
        </div>

        <!-- Download/Export options modal -->
        <div id="download-panel-overlay" class="modal-overlay hidden">
          <div class="modal-content download-panel-modal">
            <div class="modal-header">
              <h3 data-i18n="download_options">📥 下载 / 导出</h3>
              <button class="btn-icon" id="btn-close-download-panel">✕</button>
            </div>
            <div class="download-panel-body">
              <!-- Combined EPUB -->
              <div class="dl-section">
                <h4 data-i18n="combine_book">合并全书 EPUB</h4>
                <div class="dl-option-row">
                  <label><input type="checkbox" id="dl-include-annotations" checked /> <span data-i18n="include_annotations">包含翻译附注</span></label>
                </div>
                <div class="dl-option-row" id="dl-ann-placement-row">
                  <label data-i18n="annotation_placement">附注位置：</label>
                  <select id="dl-ann-placement">
                    <option value="end" data-i18n="ann_at_end">全书末尾</option>
                    <option value="chapter" data-i18n="ann_after_chapter">每章后面</option>
                  </select>
                </div>
                <div class="dl-option-row">
                  <label><input type="checkbox" id="dl-include-highlights" /> <span data-i18n="include_highlights">包含划线笔记</span></label>
                </div>
                <div class="dl-option-row">
                  <label><input type="checkbox" id="dl-include-qa" /> <span data-i18n="include_qa">包含 AI Q&A</span></label>
                </div>
                <button class="btn btn-primary" id="btn-combine-download" data-i18n="combine_download">合并为完整 EPUB 并下载</button>
              </div>

              <hr class="dl-divider" />

              <!-- Individual downloads -->
              <div class="dl-section">
                <h4 data-i18n="individual_downloads">单独下载</h4>
                <div class="dl-btn-group">
                  <button class="btn btn-sm" id="btn-download-annotations" data-i18n="download_annotations_epub">📥 附注 EPUB</button>
                  <button class="btn btn-sm" id="btn-download-qa" data-i18n="download_qa_epub">📥 Q&A EPUB</button>
                  <button class="btn btn-sm" id="btn-download-highlights-epub" data-i18n="download_highlights_epub">📥 划线笔记 EPUB</button>
                  <button class="btn btn-sm" id="btn-download-highlights-md" data-i18n="download_highlights_md">📥 划线笔记 Markdown</button>
                </div>
              </div>

              <hr class="dl-divider" />

              <!-- Project export -->
              <div class="dl-section">
                <h4 data-i18n="export_project_title">导出项目</h4>
                <p class="hint" data-i18n="export_project_hint">导出项目文件(.json)可分享给他人，对方可在自己的 BiTranslator 实例中导入并浏览全部内容。</p>
                <div class="dl-option-row">
                  <label><input type="checkbox" id="dl-export-highlights" checked /> <span data-i18n="export_include_highlights">包含划线笔记</span></label>
                </div>
                <button class="btn btn-sm" id="btn-export-project" data-i18n="export_project">📤 导出项目</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card full-width">
          <h3 data-i18n="download_chapters">逐章下载</h3>
          <div id="chapter-download-list"></div>
        </div>
      </section>

      <!-- Name table modal -->
      <div id="name-table-overlay" class="modal-overlay hidden">
        <div class="modal-content name-table-modal">
          <div class="modal-header">
            <h3 data-i18n="name_table">📋 全书人名表</h3>
            <button class="btn-icon" id="btn-close-name-table">✕</button>
          </div>
          <p class="hint" data-i18n="name_table_hint">显示翻译过程中检测到的出现两次以上的人名及其译名。仅显示人名统计，不包含一次性出现的名字。</p>
          <p class="hint" style="color:var(--warning,#e6a817);font-weight:600;" data-i18n="name_table_experimental">⚠️ 此功能仍为实验性功能，人名匹配和译名检测可能不完全准确。一键统一译名功能暂未开放。</p>
          <div class="te-toolbar">
            <button class="btn btn-outline btn-sm" id="btn-rescan-names" data-i18n="rescan_names">🔄 重新扫描全书人名</button>
            <span class="hint" data-i18n="rescan_names_hint">重新扫描所有已翻译章节，更新人名统计</span>
          </div>
          <div id="name-table-content"></div>
          <div class="btn-row" style="margin-top:1rem">
            <button class="btn" id="btn-cancel-name-table" data-i18n="close">关闭</button>
          </div>
        </div>
      </div>

      <!-- Title editor modal (shared by review & reader) -->
      <div id="title-editor-overlay" class="modal-overlay hidden">
        <div class="modal-content title-editor-modal">
          <div class="modal-header">
            <h3 data-i18n="edit_chapter_titles">✏️ 编辑章节标题</h3>
            <button class="btn-icon" id="btn-close-title-editor">✕</button>
          </div>
          <p class="hint" data-i18n="edit_titles_hint">设置章节类型（前言/正文/附录）和双语标题。正文类章节将自动编号。</p>
          <div class="te-toolbar">
            <button class="btn btn-outline btn-sm" id="btn-ai-translate-titles" data-i18n="ai_translate_titles">🤖 AI 一键翻译所有标题</button>
            <button class="btn btn-sm" id="btn-auto-number" data-i18n="auto_number">🔢 自动编号正文章节</button>
            <button class="btn btn-sm" id="btn-strip-numbers" data-i18n="strip_numbers">🔢 去除译文编号</button>
            <button class="btn btn-sm" id="btn-copy-numbers" data-i18n="copy_numbers">🔢 从原文复制编号到译文</button>
          </div>
          <div id="title-editor-list" class="title-editor-list"></div>
          <div class="btn-row" style="margin-top:1rem">
            <button class="btn btn-primary" id="btn-save-titles" data-i18n="save_all_titles">保存所有标题</button>
            <button class="btn" id="btn-cancel-title-editor" data-i18n="cancel">取消</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="module" src="app.js?v=30"></script>
</body>
</html>
